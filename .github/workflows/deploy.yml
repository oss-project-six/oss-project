name: Spring Boot Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. μ†μ¤μ½”λ“ μ²΄ν¬μ•„μ›ƒ
    - name: Checkout source code
      uses: actions/checkout@v3

    # 2. Java 17 μ„¤μΉ
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. application.yml λ³µμ› (base64 β†’ μ›λ³Έ)
    - name: Create application.yml from base64
      run: |
        mkdir -p src/main/resources
        echo "${{ secrets.APPLICATION_YML_BASE64 }}" | base64 -d > src/main/resources/application.yml

    # 4. gradlew μ‹¤ν–‰ κ¶ν• λ¶€μ—¬
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    # 5. Gradle λΉλ“
    - name: Build with Gradle
      run: ./gradlew clean build

    # 6. λΉλ“ κ²°κ³Όλ¬Ό ν™•μΈ (λ””λ²„κΉ…μ©)
    - name: Check build output
      run: |
        echo "π“ build/libs λ””λ ‰ν† λ¦¬ λ‚΄μ©:"
        ls -al build/libs/
        echo "π“ ν„μ¬ λ””λ ‰ν† λ¦¬:"
        ls -al .

    # 7. SSH ν‚¤ μ¤€λΉ„ (CIμ—μ„ μ‚¬μ©ν•  κ°μΈν‚¤ μƒμ„±)
    - name: Prepare SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SERVER_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

    # 8. scpλ΅ JARκ³Ό deploy.shλ¥Ό μ„λ²„λ΅ λ³µμ‚¬
    - name: Copy jar and deploy.sh via scp
      run: |
        # κ²½λ΅ λ³€μ μ„¤μ •
        JAR_PATH=build/libs/oss-project-0.0.1-SNAPSHOT.jar
        SCRIPT_PATH=deploy.sh
        REMOTE="${{ secrets.DEPLOY_SERVER_USER }}@${{ secrets.DEPLOY_SERVER_IP }}:${{ secrets.DEPLOY_DIRECTORY }}"

        # νμΌμ΄ μ΅΄μ¬ν•λ”μ§€ λ΅μ»¬μ—μ„ ν™•μΈ
        if [ ! -f "$JAR_PATH" ]; then
          echo "β ERROR: JAR νμΌμ΄ μ—†μµλ‹λ‹¤: $JAR_PATH"
          exit 1
        fi
        if [ ! -f "$SCRIPT_PATH" ]; then
          echo "β ERROR: deploy.sh νμΌμ΄ μ—†μµλ‹λ‹¤: $SCRIPT_PATH"
          exit 1
        fi

        # μ‹¤μ  scp λ…λ Ή μ‹¤ν–‰
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa "$JAR_PATH" "$SCRIPT_PATH" "$REMOTE"

    # 9. SSHλ΅ μ„λ²„μ— μ ‘μ†ν•μ—¬ deploy.sh μ‹¤ν–‰
    - name: Execute deploy.sh on remote server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_SERVER_IP }}
        username: ${{ secrets.DEPLOY_SERVER_USER }}
        key: ${{ secrets.DEPLOY_SERVER_KEY }}
        script: |
          cd ${{ secrets.DEPLOY_DIRECTORY }}
          chmod +x deploy.sh
          ./deploy.sh
